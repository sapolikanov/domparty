---
title: "Data Building"
format: 
  pdf:
    fig-pos: "H"
    fontsize: 11pt
    highlight-style: breezedark
    fig-width: 7
    fig-height: 5
    include-in-header:
      - text: |
          \addtokomafont{disposition}{\rmfamily} 
          \AddToHook{env/Highlighting/begin}{\scriptsize} 
          \usepackage{float} 
          \usepackage[backend = biber, style = apa]{biblatex}
          \addbibresource{../../bibliography/domparty.bib}
execute: 
  echo: true
  warning: false
  error: false
  message: false
---

```{r}
#| label: setup
#| include: false

library(here)
source(here("utilities", "check_packages.R"))
source(here("utilities", "functions.R"))

theme_set(theme_minimal())
```

I start with reading in the data.

```{r}
#| label: read data

party_class <- read_excel(here("data", "data_raw", "partyreg.xlsx"))
colonial <- read_csv(here("data", "data_raw", "COLDAT_colonies.csv"))
vdem <- readRDS(here("data", "data_raw", "V-Dem-CY-Full+Others-v10.rds"))
epr <- read_csv(here("data", "data_raw", "EPR.csv"))
dpi <- read_dta(here("data", "data_raw", "DPI2020.dta"))
vparty <- read_rds(here("data", "data_raw", "V-Dem-CPD-Party-V2.rds"))
wb_oil <- read_csv(here("data", "data_raw", 
                        "API_NY.GDP.PETR.RT.ZS_DS2_en_csv_v2_2446738.csv"))
```

Create a character vector of country-year pairs for subsetting.

```{r}
#| label: create countryyear pair vector from hand-coded data

cy <- str_c(party_class$ccodecow, party_class$year, sep = "_")
```

I construct dummies for the colonial legacies of sub-Saharan African countries from the Colonial Dates dataset \parencite{becker_colonial_2019}.

```{r}
#| label: modify colonial dates data

col_legacy <- colonial |> 
  mutate(ccodecow = countryname(country, destination = "cown", warn = F)) |> 
  filter(ccodecow %in% party_class$ccodecow) |> 
  reframe(ccodecow, col.britain, col.france,
          col.other = if_else((col.britain == 0 & col.france == 0)
                              & (col.belgium == 1 | col.germany == 1
                                 | col.italy == 1 | col.netherlands == 1
                                 | col.portugal == 1 | col.spain == 1), 1, 0),
          col.none = if_else(col.other == 0 & col.britain == 0
                             & col.france == 0, 1, 0),
          col.type = case_when(col.britain == 1 & col.france == 0 
                               & col.other == 0 ~ "Britain",
                               col.france == 1 & col.britain == 0 
                               & col.other == 0 ~ "France",
                               col.other == 1 & col.britain == 0 
                               & col.france == 0 ~ "Other",
                               col.none == 1 ~ "None",
                               .default = "Mixed"))

ggplot(col_legacy, aes(x = col.type)) +
  geom_bar(fill = "grey60", width = 0.75) +
  geom_text(aes(label = after_stat(count)), stat = "count", vjust = 2) + 
  labs(title = "Colonial Legacies of Sub-Saharan African Countries",
       subtitle = paste0("N = ", sum(!is.na(col_legacy$col.type)), " of ", 
                         length(col_legacy$col.type), 
                         " possible countries in the sample."),
       caption = 
         "\nsource: Colonial Dates Dataset (COLDAT), Becker et al. (2019)",
       x = "\nColonial Power",
       y = "Number of Countries\n")
```

The result is that some countries had colonial histories with both Britain and France, either of those, a different metropole, or were not colonized at all.

Party system institutionalization data comes from V-Dem v10 (march 2020) \parencite{coppedge_v-dem_2020}. 

```{r}
#| label: modify PSI data

psi <- vdem |> 
  select(country_name, ccodecow = COWcode, year, v2xps_party) |> 
  mutate(v2xps_party_mean = if_else(is.na(v2xps_party)
                                    & str_c(ccodecow, year, sep = "_") %in% cy,
                                    round(mean(v2xps_party[year >= 2013
                                                           & year <= 2018], 
                                         na.rm = T), 3), v2xps_party),
         v2xos_party_next = if_else(is.na(v2xps_party)
                                    & str_c(ccodecow, year, sep = "_") %in% cy,
                                    lead(v2xps_party, 1), v2xps_party)) |> 
  filter(str_c(ccodecow, year, sep = "_") %in% cy)

ggplot(psi, aes(x = v2xps_party_mean)) +
  geom_density() +
  geom_dotplot(fill = "grey60", binwidth = 0.03) +
  labs(title = 
         "Party System Institutionalization in Sub-Saharan African Countries",
       caption = "\nsource: V-Dem v10 (march 2020), Coppedge et al. (2020)",
       subtitle = paste0("N = ", sum(!is.na(psi$v2xps_party_mean)), " of ", 
                         length(psi$v2xps_party_mean), 
                         " possible countries in the sample. For ",
                         sum(!is.na(psi$v2xps_party_mean))
                         - sum(!is.na(psi$v2xps_party)),
                         " countries with missing PSI for the\n",
                         "election year are imputed with the mean of the PSI ",
                         "index for 2013-2018.\n"),
       x = "\nPSI Index",
       y = "Density\n")
```

There are two instances when the PSI index is not recorded by V-Dem in the delineated geographical and temporal scope: Mali in 2013 and Guinea in 2013. I fill these with the mean of the PSI index for these countries for the years 2013-2018. The decision is aimed at minimizing missing values in an already very small sample. This may be suboptimal, so I also provide a sensitivity analysis to this choice. I compare the mean solution with imputing the next value or discarding the observations altogether.

The data on the level of democracy also comes from V-Dem v10 \parencite{coppedge_v-dem_2020}. I use the V-Dem polyarchy measure.

```{r}
dem <- vdem |> 
  select(ccodecow = COWcode, year, v2x_polyarchy) |> 
  filter(str_c(ccodecow, year, sep = "_") %in% cy)

ggplot(dem, aes(x = v2x_polyarchy)) +
  geom_density() +
  geom_dotplot(fill = "grey60", binwidth = 0.03) +
  labs(title = 
         "Democracy in Sub-Saharan African Countries",
       caption = "\nsource: V-Dem v10 (march 2020), Coppedge et al. (2020)",
       subtitle = paste0("N = ", sum(!is.na(dem$v2x_polyarchy)), " of ", 
                         length(dem$v2x_polyarchy), 
                         " possible countries in the sample.\n"),
       x = "\nPolyarchy Index",
       y = "Density\n")
```

I use Ethnic Power Relations core dataset to construct a measure of ethno-linguistic
fragmentation (ELF) \parencite{vogt_integrating_2015}. The ELF index is a measure of the probability that two randomly selected individuals in a country belong to different ethno-linguistic groups. The calculation is straightforward: 

$$ELF_i = 1 - \sum_{j = 1}^{K}s_j^2$$

where for to get the ELF index for country $i$, I deduct from 1 the sum of squared proportions $s$ of ethnic groups $j$ across $K$ groups in a country.

```{r}
#| label: modify EPR data

elf <- epr |> 
  mutate(ccodecow = countryname(statename, destination = "cown")) |>
  group_by(statename, ccodecow, from, to) |> 
  summarize(elf = 1 - sum(size^2)) |> 
  mutate(year = list(seq(from, to))) |> 
  unnest(year) |> 
  ungroup() |> 
  select(-from, -to) |> 
  full_join(select(party_class, ccodecow, year)) |> 
  arrange(ccodecow, year) |> 
  group_by(ccodecow) |> 
  mutate(elf_fill = if_else(is.na(elf), lag(elf, 1), elf)) |> 
  right_join(select(party_class, ccodecow, year)) |> 
  ungroup()

ggplot(elf, aes(x = elf_fill)) +
  geom_density() +
  geom_dotplot(fill = "grey60", binwidth = 0.04) +
  labs(title = "Ethno-linguistic fragmentation in Sub-Saharan African Countries",
       subtitle = paste0("N = ", sum(!is.na(elf$elf_fill)), ", of ", 
                         length(elf$elf_fill), " possible countries in the sample.\nFor ", 
                         sum(!is.na(elf$elf_fill)) - sum(!is.na(elf$elf)),
                         " countries the ELF index for 2018 is imputed with the 2017 value.\n"),
       caption = "\nsource: Ethnic Power Relations Dataset (EPR), Vogt et al. (2015)",
       x = "\nELF Index",
       y = "Density\n")
```

Data on the electoral rules for the lower house of the national legislature comes from the Database of Political Institutions (DPI) \parencite{patrick_new_2010}. I focus on the type of electoral system used in the most recent election year. The data is coded as 0 for proportional representation and 1 for plurality.

```{r}
#| label: modify political institutions data

housesys <- dpi |> 
  select(countryname, ifs, year, housesys) |> 
  mutate(ccodecow_1 = countrycode(ifs, origin = "iso3c", destination = "cown"),
         ccodecow_2 = countryname(countryname, destination = "cown"),
         ccodecow = case_when(ccodecow_1 == ccodecow_2 ~ ccodecow_1,
                              is.na(ccodecow_1) ~ ccodecow_2,
                              is.na(ccodecow_2) ~ ccodecow_1,
                              !is.na(ccodecow_1) 
                              & !is.na(ccodecow_2) ~ ccodecow_1),
         housesys = factor(if_else(housesys == -999, NA, housesys),
                           levels = c(0, 1), 
                           labels = c("Proportional",
                                      "Plural"))) |> 
  filter(str_c(ccodecow, year, sep = "_") %in% cy) |> 
  right_join(select(party_class, ccodecow, year))

ggplot(housesys, aes(x = housesys)) +
  geom_bar(fill = "grey60", width = 0.75) + 
  labs(title = "Type of Political Institutions in Sub-Saharan African Countries",
       subtitle = paste0("N = ", sum(!is.na(housesys$housesys)), " of ", 
                         length(housesys$housesys), 
                         " possible countries in the sample.\n"),
       caption = "\nsource: Database of Political Institutions (DPI), Arel-Bundock (2020)",
       x = "\nType of Political Institutions",
       y = "Number of countries\n")
```

There are around twice as many countries with plurality as with with proportional representation in the sample. For 4 countries data is unavailable. For Sao Tome and Principe and the Seychelles, the project does not collect data, and for Guinea and Sudan, the data is missing in source. 

The data on effective number of parties comes from the V-Party dataseet.

```{r}
#| label: modify enp data

enp <- vparty |> 
  select(country_name, year, ccodecow = COWcode, v2paseatshare,
         v2pavote) |>
  filter(str_c(ccodecow, year, sep = "_") %in% cy) |>
  mutate(across(c(v2paseatshare, v2pavote), ~ ./100)) |>
  group_by(ccodecow, year) |> 
  summarize(enpp = 1/sum(v2paseatshare^2, na.rm = T),
            enpv = 1/sum(v2pavote^2, na.rm = T),
            enpv = if_else(is.infinite(enpv), NA, enpv),
            .groups = "drop") |>
  right_join(select(party_class, ccodecow, year))
```

```{r}
#| label: modify world bank data

oil <- wb_oil |> 
  pivot_longer(cols = -c("Country Name", "Country Code", "Indicator Name", 
                         "Indicator Code"), 
               names_to = "year", values_to = "oil_rent_perc_gdp") |> 
  mutate(ccodecow = countryname(`Country Name`, 
                                destination = "cown"),
         oil_rent_dummy = if_else(oil_rent_perc_gdp != 0, 1, 0)) |> 
  filter(str_c(ccodecow, year, sep = "_") %in% cy) 
```


\printbibliography

