---
title: "Data Building"
format: 
  pdf:
    fig-pos: "H"
    fontsize: 11pt
    highlight-style: kate
    include-in-header:
      - text: |
          \addtokomafont{disposition}{\rmfamily} 
          \AddToHook{env/Highlighting/begin}{\scriptsize} 
          \usepackage{float} 
          \usepackage[backend = biber, style = apa]{biblatex}
          \addbibresource{../../bibliography/domparty.bib}
execute: 
  echo: true
  warning: false
  error: false
  message: false
---

```{r}
#| label: setup
#| include: false

library(here)
source(here("utilities", "check_packages.R"))
source(here("utilities", "functions.R"))

theme_set(theme_minimal())
```

I start with reading in the data.

```{r}
#| label: read data

party_class <- read_excel(here("data", "data_raw", "partyreg.xlsx"))
colonial <- read_csv(here("data", "data_raw", "COLDAT_colonies.csv"))
vdem <- readRDS(here("data", "data_raw", "V-Dem-CY-Full+Others-v10.rds"))
epr <- read_csv(here("data", "data_raw", "EPR.csv"))
dpi <- read_dta(here("data", "data_raw", "DPI2020.dta"))
```

```{r}
#| label: create countryyear pair vector from hand-coded data

cy <- str_c(party_class$ccodecow, party_class$year, sep = "_")
```

I construct dummies for the colonial legacies of sub-Saharan African countries from the Colonial Dates dataset \parencite{becker_colonial_2019}.

```{r}
#| label: modify colonial dates data

col_legacy <- colonial |> 
  mutate(ccodecow = countryname(country, destination = "cown", warn = F)) |> 
  filter(ccodecow %in% party_class$ccodecow) |> 
  reframe(ccodecow, col.britain, col.france,
          col.other = if_else((col.britain == 0 & col.france == 0)
                              & (col.belgium == 1 | col.germany == 1
                                 | col.italy == 1 | col.netherlands == 1
                                 | col.portugal == 1 | col.spain == 1), 1, 0),
          col.none = if_else(col.other == 0 & col.britain == 0
                             & col.france == 0, 1, 0),
          col.type = case_when(col.britain == 1 & col.france == 0 
                               & col.other == 0 ~ "Britain",
                               col.france == 1 & col.britain == 0 
                               & col.other == 0 ~ "France",
                               col.other == 1 & col.britain == 0 
                               & col.france == 0 ~ "Other",
                               col.none == 1 ~ "None",
                               .default = "Mixed"))

ggplot(col_legacy, aes(x = col.type)) +
  geom_bar(fill = "grey60") +
  labs(title = "Colonial Legacies of Sub-Saharan African Countries",
       x = "\nColonial Power",
       y = "Number of Countries")
```

The result is that some countries had colonial histories with both Britain and France, either of those a different metropole, or were not colonized at all.

Party system institutionalization data comes from V-Dem v10 (march 2020) \parencite{coppedge_v-dem_2020}. 

```{r}
#| label: modify PSI data

psi <- vdem |> 
  select(country_name, ccodecow = COWcode, year, v2xps_party) |> 
  mutate(v2xps_party_mean = if_else(is.na(v2xps_party)
                                    & str_c(ccodecow, year, sep = "_") %in% cy,
                                    round(mean(v2xps_party[year >= 2013 & year <= 2018], 
                                         na.rm = T), 3), v2xps_party),
         v2xos_party_next = if_else(is.na(v2xps_party)
                                    & str_c(ccodecow, year, sep = "_") %in% cy,
                                    lead(v2xps_party, 1), v2xps_party)) |> 
  filter(str_c(ccodecow, year, sep = "_") %in% cy)

ggplot(psi, aes(x = v2xps_party_mean)) +
  geom_density() +
  geom_dotplot(fill = "grey60", binwidth = 0.03) +
  labs(title = "Party System Institutionalization in Sub-Saharan African Countries\n",
       x = "\nPSI Index",
       y = "Density\n")
  
```

There are two instances when the PSI index is not recorded by V-Dem in the delineated geographical and temporal scope: Mali in 2013 and Guinea in 2013. I fill these with the mean of the PSI index for these countries for the years 2013-2018. The decision is aimed at minimizing missing values in an already very small sample. This may be suboptimal, so I also provide a sensitivity analysis to this choice. I compare the mean solution with imputing the next value or discarding the observations altogether.

```{r}
#| label: modify EPR data

elf <- epr |> 
  mutate(ccodecow = countryname(statename, destination = "cown")) |>
  group_by(statename, ccodecow, from, to) |> 
  summarize(elf = 1 - sum(size^2)) |> 
  mutate(year = list(seq(from, to))) |> 
  unnest(year) |> 
  ungroup() |> 
  select(-from, -to) |> 
  full_join(select(party_class, ccodecow, year)) |> 
  arrange(ccodecow, year) |> 
  group_by(ccodecow) |> 
  mutate(elf_fill = if_else(is.na(elf), lag(elf, 1), elf)) |> 
  right_join(select(party_class, ccodecow, year)) |> 
  ungroup()

ggplot(elf, aes(x = elf_fill)) +
  geom_density() +
  geom_dotplot(fill = "grey60", binwidth = 0.04) +
  labs(title = "Ethno-linguistic fragmentation in Sub-Saharan African Countries",
       subtitle = paste0("N = ", sum(!is.na(elf$elf_fill)), ", of ", 
                         length(elf$elf_fill), " possible countries in the sample.\nFor ", 
                         sum(!is.na(elf$elf_fill)) - sum(!is.na(elf$elf)),
                         " countries the ELF index for 2018 is imputed with the 2017 value"),
       x = "\nELF Index",
       y = "Density\n")
```

```{r}
#| label: modify political institutions data

housesys <- dpi |> 
  select(countryname, ifs, year, housesys) |> 
  mutate(ccodecow = case_when(is.na(countryname(countryname, 
                                                destination = "cown"))))
```


\printbibliography

